<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Categories</title>

    <!-- Bootstrap -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />

    <style>
      body {
        background-color: #f4f4f4;
      }
      .page-title {
        margin: 30px 0;
      }
    </style>
  </head>

  <body>
    <!--  LOGIN CHECK -->
    <script>
      if (!localStorage.getItem("userId")) {
        window.location.href = "login.html";
      }
    </script>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <span class="navbar-brand"> Welcome, <span id="username"></span> </span>

      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" href="index.html">Dashboard</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="category.html">Categories</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="product.html">Products</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="customer.html">Customer</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="order.html">Order</a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-danger" href="login.html" onclick="logout()"
            >Logout</a
          >
        </li>
      </ul>
    </nav>

    <div class="container">
      <h3 class="page-title">Category Management</h3>

      <!-- ADD / UPDATE FORM -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 id="formTitle">Add New Category</h5>

          <div class="form-inline">
            <input
              type="text"
              id="categoryName"
              class="form-control mr-2"
              placeholder="Category name"
            />

            <button
              class="btn btn-primary"
              onclick="saveCategory()"
              id="saveBtn"
            >
              Add
            </button>

            <button
              class="btn btn-secondary ml-2 d-none"
              onclick="cancelEdit()"
              id="cancelBtn"
            >
              Cancel
            </button>
          </div>

          <small id="message" class="form-text mt-2"></small>
        </div>
      </div>

      <!-- CATEGORY LIST -->
      <div class="card">
        <div class="card-body">
          <h5>Category List</h5>

          <table class="table table-bordered mt-3">
            <thead class="thead-light">
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th style="width: 120px">Action</th>
              </tr>
            </thead>
            <tbody id="categoryTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      // USERNAME
      document.getElementById("username").innerText =
        localStorage.getItem("userName") || "User";

      let editCategoryId = null;

      function logout() {
        localStorage.clear();
        window.location.href = "login.html";
      }

      // LOAD ALL CATEGORIES
      function loadCategories() {
        fetch("http://localhost:8080/category")
          .then((res) => res.json())
          .then((data) => {
            const table = document.getElementById("categoryTable");
            table.innerHTML = "";

            data.forEach((cat) => {
              table.innerHTML += `
                        <tr>
                            <td>${cat.id}</td>
                            <td>${cat.name}</td>
                            <td>
                                <button
                                    class="btn btn-sm btn-warning"
                                    onclick="editCategory(${cat.id}, '${cat.name}')">
                                    Edit
                                </button>

                                <button
            class="btn btn-sm btn-danger"
            onclick="deleteCategory(${cat.id})">
            Delete
        </button>
                            </td>
                        </tr>
                    `;
            });
          });
      }

      // ADD or UPDATE CATEGORY
      function saveCategory() {
        const name = document.getElementById("categoryName").value.trim();
        const msg = document.getElementById("message");

        msg.innerText = "";

        if (name === "") {
          msg.innerText = "Category name cannot be empty.";
          msg.style.color = "red";
          return;
        }

        fetch("http://localhost:8080/category")
          .then((res) => res.json())
          .then((categories) => {
            let request = null; 

            // ADD
            if (editCategoryId === null) {
              const exists = categories.some(
                (c) => c.name.toLowerCase() === name.toLowerCase()
              );

              if (exists) {
                msg.innerText = "Category name already exists.";
                msg.style.color = "red";
                return null;
              }

              request = fetch("http://localhost:8080/category/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name }),
              });
            }

            // UPDATE
            else {
              const exists = categories.some(
                (c) =>
                  c.name.toLowerCase() === name.toLowerCase() &&
                  c.id !== editCategoryId
              );

              if (exists) {
                msg.innerText =
                  "Another category with this name already exists.";
                msg.style.color = "red";
                return null;
              }

              request = fetch(
                `http://localhost:8080/category/${editCategoryId}?name=${encodeURIComponent(
                  name
                )}`,
                { method: "PUT" }
              );
            }

            return request;
          })
          .then((res) => {
            if (!res) return; 
            if (!res.ok) throw new Error();
            return res.text();
          })
          .then((result) => {
            if (!result) return; 

            msg.innerText =
              editCategoryId === null
                ? "Category added successfully."
                : "Category updated successfully.";
            msg.style.color = "green";

            cancelEdit();
            document.getElementById("categoryName").value = "";
            loadCategories();
          })
          .catch(() => {
            msg.innerText = "Operation failed.";
            msg.style.color = "red";
          });
      }

      function editCategory(id, name) {
        editCategoryId = id;
        document.getElementById("categoryName").value = name;
        document.getElementById("formTitle").innerText = "Update Category";
        document.getElementById("saveBtn").innerText = "Update";
        document.getElementById("cancelBtn").classList.remove("d-none");
      }

      function cancelEdit() {
        editCategoryId = null;
        document.getElementById("categoryName").value = "";
        document.getElementById("formTitle").innerText = "Add New Category";
        document.getElementById("saveBtn").innerText = "Add";
        document.getElementById("cancelBtn").classList.add("d-none");
      }

      function deleteCategory(id) {
        if (!confirm("Are you sure you want to delete this category?")) {
          return;
        }

        fetch(`http://localhost:8080/category/delete/${id}`, {
          method: "DELETE",
        })
          .then((res) => {
            if (!res.ok) {
              throw new Error("Delete failed");
            }
            return res.text();
          })
          .then(() => {
            alert("Category deleted successfully.");
            loadCategories();
          })
          .catch(() => {
            alert("Category has products. Cannot delete.");
          });
      }

      loadCategories();
    </script>
  </body>
</html>
